{% extends 'base.html' %}

{% block title %}Registrar Refeição{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card p-4 shadow-lg border-0 bg-white">
        <h1 class="mb-4 text-primary">
            <i class="fas fa-utensils me-3"></i>Registrar Refeição
        </h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form id="form-registro-refeicao" action="{{ url_for('registrar_refeicao') }}" method="post">
            <h5 class="text-secondary mb-3"><i class="fas fa-calendar-check me-2"></i>Informações Básicas</h5>

            <div class="mb-3 input-group">
                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                <div class="form-floating">
                    <input type="datetime-local" class="form-control" id="data_hora" name="data_hora" required>
                    <label for="data_hora">Data e Hora</label>
                </div>
            </div>

            <div class="mb-4 input-group">
                <span class="input-group-text"><i class="fas fa-utensils"></i></span>
                <div class="form-floating">
                    <select class="form-select" id="refeicao" name="tipo" required>
                        <option value="" disabled selected>Selecione a Refeição...</option>
                        <option value="Jejum">Jejum</option>
                        <option value="Café da Manhã">Café da Manhã</option>
                        <option value="Almoço">Almoço</option>
                        <option value="Janta">Janta</option>
                        <option value="Lanche">Lanche</option>
                        <option value="Colação">Colação</option>
                    </select>
                    <label for="refeicao">Tipo de Refeição</label>
                </div>
            </div>

            <h5 class="text-secondary mb-3"><i class="fas fa-search me-2"></i>Busca e Adição de Alimentos</h5>

            <div class="mb-3">
                <div class="input-group">
                    <input type="text" id="alimento_busca" class="form-control"
                        placeholder="Digite 3 ou mais letras para pesquisar...">
                </div>
            </div>

            <div id="resultados_busca_alimentos" class="list-group mb-4">
            </div>

            <h5 class="text-secondary mb-3"><i class="fas fa-list-ul me-2"></i>Itens da Refeição</h5>
            <ul id="lista_alimentos_selecionados" class="list-group">
            </ul>

            <input type="hidden" name="alimentos_selecionados" id="alimentos_selecionados_input" value="[]">
            <input type="hidden" name="total_carbs" id="total_carbs_input" value="0.00">
            <input type="hidden" name="total_kcal" id="total_kcal_input" value="0.00">

            <div class="mt-4 pt-3 border-top">
                <div class="mb-2 text-end fs-5">
                    <strong>Total de Carboidratos:</strong>
                    <span id="total_carbs_span" class="fw-bold text-success">0.00</span>g
                </div>
                <div class="mb-3 text-end fs-5">
                    <strong>Total de Calorias:</strong>
                    <span id="total_kcal_span" class="fw-bold text-success">0.00</span>kcal
                </div>
            </div>

            <h5 class="text-secondary mb-3"><i class="fas fa-comment-dots me-2"></i>Observações</h5>
            <div class="mb-3 input-group">
                <span class="input-group-text align-items-start pt-3"><i class="fas fa-comment-dots"></i></span>
                <div class="form-floating">
                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                        placeholder="Observações (opcional)"></textarea>
                    <label for="observacoes">Detalhes e anotações (opcional)</label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 btn-lg shadow-lg mt-3">
                <i class="fas fa-save me-2"></i>Registrar Refeição
            </button>
        </form>
    </div>
</div>

<script>
    // Usando url_for do Jinja para rotas robustas
    const URL_BUSCA_ALIMENTOS = "{{ url_for('buscar_alimentos') }}";

    document.addEventListener('DOMContentLoaded', function () {
        // Inicialização de Elementos DOM
        const refeicaoSelect = document.getElementById('refeicao');
        const searchInput = document.getElementById('alimento_busca');
        const resultsContainer = document.getElementById('resultados_busca_alimentos');
        const listaAlimentos = document.getElementById('lista_alimentos_selecionados');
        const totalCarbsSpan = document.getElementById('total_carbs_span');
        const totalKcalSpan = document.getElementById('total_kcal_span');
        const alimentosSelecionadosInput = document.getElementById('alimentos_selecionados_input');
        const totalCarbsInput = document.getElementById('total_carbs_input');
        const totalKcalInput = document.getElementById('total_kcal_input');
        let timeoutId;

        // --- Funções de Utilitário ---

        /** Atualiza o campo data_hora para o momento atual. */
        function preencherDataHoraAtual() {
            const dataHoraInput = document.getElementById('data_hora');
            if (!dataHoraInput.value) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                dataHoraInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        }

        /** Recalcula os totais de carboidratos e calorias de um item individual. */
        function recalcularItem(item) {
            const quantidade = parseFloat(item.querySelector('.input-quantidade').value) || 0;
            const carbsPorMedida = parseFloat(item.querySelector('.alimento-carbs-base').value) || 0;
            const kcalPorMedida = parseFloat(item.querySelector('.alimento-kcal-base').value) || 0;

            const totalItemCarbs = quantidade * carbsPorMedida;
            const totalItemKcal = quantidade * kcalPorMedida;

            item.querySelector('.carbs-calculados').textContent = totalItemCarbs.toFixed(2);
            item.querySelector('.kcal-calculados').textContent = totalItemKcal.toFixed(2);
        }

        /** Soma os totais de todos os itens e atualiza os campos de exibição e ocultos. */
        function atualizarTotais() {
            let totalCarbs = 0;
            let totalKcal = 0;

            document.querySelectorAll('.carbs-calculados').forEach(span => {
                totalCarbs += parseFloat(span.textContent) || 0;
            });
            document.querySelectorAll('.kcal-calculados').forEach(span => {
                totalKcal += parseFloat(span.textContent) || 0;
            });

            // Atualiza exibição e campos ocultos
            totalCarbsSpan.textContent = totalCarbs.toFixed(2);
            totalKcalSpan.textContent = totalKcal.toFixed(2);
            totalCarbsInput.value = totalCarbs.toFixed(2);
            totalKcalInput.value = totalKcal.toFixed(2);

            atualizarCampoOculto();
        }

        /** Coleta os dados de todos os itens da lista e serializa para JSON. */
        function atualizarCampoOculto() {
            const alimentos = [];
            document.querySelectorAll('#lista_alimentos_selecionados > li').forEach(li => {
                const nome = li.querySelector('.alimento-nome').value;
                const carbs = parseFloat(li.querySelector('.carbs-calculados').textContent);
                const kcal = parseFloat(li.querySelector('.kcal-calculados').textContent);
                const quantidade = parseFloat(li.querySelector('.input-quantidade').value);
                const carbsPorMedidaBase = parseFloat(li.querySelector('.alimento-carbs-base').value);
                const kcalPorMedidaBase = parseFloat(li.querySelector('.alimento-kcal-base').value);

                alimentos.push({
                    "nome": nome,
                    "carbs_total": carbs,
                    "kcal_total": kcal,
                    "quantidade": quantidade,
                    "carbs_base": carbsPorMedidaBase,
                    "kcal_base": kcalPorMedidaBase
                });
            });
            alimentosSelecionadosInput.value = JSON.stringify(alimentos);
        }

        /** Adiciona um alimento selecionado à lista na interface. */
        function adicionarAlimentoNaLista(nome, carbsPorMedida, kcalPorMedida, medidaCaseira, pesoGrama) {
            const novoItem = document.createElement('li');
            novoItem.classList.add('list-group-item', 'd-flex', 'flex-column', 'bg-light', 'rounded-3', 'mb-2', 'p-3');
            novoItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><strong>${nome}</strong></span>
                    <button type="button" class="btn btn-sm btn-danger remover-alimento-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="row g-2">
                    <div class="col-12 col-md-6">
                        <label class="form-label d-block text-muted small">Carbs por porção:</label>
                        <span class="text-primary fw-bold carbs-base">${carbsPorMedida.toFixed(2)}</span>g / 
                        <span class="text-muted small">${medidaCaseira} (${pesoGrama.toFixed(0)}g)</span>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label d-block text-muted small">Kcal por porção:</label>
                        <span class="text-primary fw-bold kcal-base">${kcalPorMedida.toFixed(2)}</span>kcal
                    </div>
                </div>
                <div class="mt-2">
                    <label class="form-label d-block text-muted small">Quantidade consumida:</label>
                    <div class="input-group">
                        <input type="number" step="0.1" class="form-control form-control-sm input-quantidade" value="1" min="0.1">
                        <span class="input-group-text">${medidaCaseira}</span>
                    </div>
                </div>
                <div class="mt-2 text-end">
                    <span class="fw-bold">Total CHO:</span> <span class="carbs-calculados fw-bold text-success">0.00</span>g | 
                    <span class="fw-bold">Total Kcal:</span> <span class="kcal-calculados fw-bold text-success">0.00</span>kcal
                </div>
                <input type="hidden" class="alimento-nome" value="${nome}">
                <input type="hidden" class="alimento-carbs-base" value="${carbsPorMedida}">
                <input type="hidden" class="alimento-kcal-base" value="${kcalPorMedida}">
                <input type="hidden" class="alimento-medida" value="${medidaCaseira}">
                <input type="hidden" class="alimento-peso" value="${pesoGrama}">
            `;

            listaAlimentos.appendChild(novoItem);

            // Adiciona Listeners para o novo item
            const inputQuantidade = novoItem.querySelector('.input-quantidade');
            inputQuantidade.addEventListener('input', function () {
                recalcularItem(novoItem);
                atualizarTotais();
            });

            novoItem.querySelector('.remover-alimento-btn').addEventListener('click', function () {
                novoItem.remove();
                atualizarTotais();
            });

            recalcularItem(novoItem); // Calcula os valores iniciais (1 porção)
            atualizarTotais();
        }

        /** Processa e exibe os resultados da busca de alimentos. */
        function exibirResultados(alimentos) {
            let html = '';
            if (!alimentos || alimentos.length === 0) {
                html = '<div class="list-group-item text-muted">Nenhum alimento encontrado.</div>';
            } else {
                alimentos.forEach(alimento => {
                    // Chaves que DEVEM ser retornadas pelo Flask na rota /buscar_alimentos
                    const nome = alimento.nome || 'Nome Indefinido';
                    const carbsPorcao = alimento.carbs_porcao || 0;
                    const kcalPorcao = alimento.kcal_porcao || 0;
                    const medida = alimento.medida_caseira || 'Porção';
                    const peso = alimento.peso_g || 100;

                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${nome}</strong>
                                <br>
                                <small>Carbs: ${carbsPorcao.toFixed(2)}g | Kcal: ${kcalPorcao.toFixed(2)}kcal | Porção: ${medida}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary adicionar-alimento-btn" 
                                data-nome="${nome}" 
                                data-carbs="${carbsPorcao}" 
                                data-kcal="${kcalPorcao}" 
                                data-medida="${medida}" 
                                data-peso="${peso}">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                    `;
                });
            }
            resultsContainer.innerHTML = html;

            // Adiciona listener para os botões 'Adicionar'
            document.querySelectorAll('.adicionar-alimento-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const { nome, carbs, kcal, medida, peso } = this.dataset;
                    adicionarAlimentoNaLista(nome, parseFloat(carbs), parseFloat(kcal), medida, parseFloat(peso));
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                });
            });
        }


        // --- Listeners de Eventos ---

        // Listener para Busca de Alimentos (Debounce)
        searchInput.addEventListener('input', function () {
            clearTimeout(timeoutId);
            const termo = searchInput.value.trim();

            if (termo.length < 3) {
                resultsContainer.innerHTML = '';
                return;
            }

            timeoutId = setTimeout(() => {
                // Requisição POST para o backend
                fetch(URL_BUSCA_ALIMENTOS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `termo_pesquisa=${encodeURIComponent(termo)}`
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Erro na resposta do servidor.');
                        return response.json();
                    })
                    .then(data => {
                        // A resposta do Flask DEVE vir como { "resultados": [array de alimentos] }
                        exibirResultados(data.resultados);
                    })
                    .catch(error => {
                        console.error('Erro na requisição:', error);
                        resultsContainer.innerHTML = '<p class="list-group-item text-danger">Erro ao buscar alimentos.</p>';
                    });
            }, 500); // 500ms de debounce
        });

        // Listener para Tipo de Refeição (Desabilita busca em 'Jejum')
        refeicaoSelect.addEventListener('change', function () {
            if (this.value === 'Jejum') {
                searchInput.value = '';
                resultsContainer.innerHTML = '';
                listaAlimentos.innerHTML = '';
                atualizarTotais();
                searchInput.disabled = true;
            } else {
                searchInput.disabled = false;
            }
        });

        // Impede que a tecla ENTER no campo de busca submeta o formulário
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') e.preventDefault();
        });

        // --- Inicialização ---
        preencherDataHoraAtual();
        if (refeicaoSelect.value === 'Jejum') searchInput.disabled = true;
    });
</script>
{% endblock %}