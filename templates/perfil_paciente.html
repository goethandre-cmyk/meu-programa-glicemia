{% extends "base.html" %}

{% block titulo %}Perfil de {{ paciente.username }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-user-circle me-2"></i>Perfil de {{ paciente.username | capitalize }}</h1>
        <a href="{{ url_for('dashboard_medico') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados Pessoais</h5>
                </div>
                <div class="card-body">
                    <p><strong>Nome de Usuário:</strong> {{ paciente.username }}</p>
                    <p><strong>Email:</strong> {{ paciente.email or 'N/A' }}</p>
                    <p><strong>Telefone:</strong> {{ paciente.telefone or 'N/A' }}</p>
                    <p><strong>Último Acesso:</strong> {{ paciente.ultimo_acesso.strftime('%d/%m/%Y %H:%M') if
                        paciente.ultimo_acesso else 'N/A' }}</p>
                </div>
                <div class="card-footer d-flex gap-2">
                    <a href="#fichaMedicaTab" data-bs-toggle="tab" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-file-medical me-2"></i>Ver Ficha Médica
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <ul class="nav nav-tabs" id="perfilTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="glicemia-tab" data-bs-toggle="tab" data-bs-target="#glicemia"
                        type="button" role="tab" aria-controls="glicemia" aria-selected="true">
                        <i class="fas fa-chart-line me-1"></i>Glicemia & Nutrição
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ficha-tab" data-bs-toggle="tab" data-bs-target="#fichaMedicaTab"
                        type="button" role="tab" aria-controls="fichaMedicaTab" aria-selected="false">
                        <i class="fas fa-notes-medical me-1"></i>Ficha Médica
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exames-tab" data-bs-toggle="tab" data-bs-target="#acompanhamentoExames"
                        type="button" role="tab" aria-controls="acompanhamentoExames" aria-selected="false">
                        <i class="fas fa-microscope me-1"></i>Acompanhamento Exames
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 p-3 bg-white shadow-sm rounded-bottom">

                <div class="tab-pane fade show active" id="glicemia" role="tabpanel" aria-labelledby="glicemia-tab">
                    {% include 'editar_parametros_snippet.html' %}
                    <h4 class="mb-3">Histórico de Registros</h4>
                    {% if registros_glicemia %}
                    <div class="mb-4">
                        <h6>Gráfico de Glicemia (mg/dL)</h6>
                        <canvas id="glicemiaChart" class="w-100"></canvas>
                    </div>

                    <div class="mb-4">
                        <h6>Gráfico de Carboidratos (g)</h6>
                        <canvas id="carbosChart" class="w-100"></canvas>
                    </div>

                    <div class="mb-4">
                        <h6>Gráfico de Kcal</h6>
                        <canvas id="kcalChart" class="w-100"></canvas>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhum registro de glicemia ou nutrição encontrado.</p>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="fichaMedicaTab" role="tabpanel" aria-labelledby="ficha-tab">
                    <h4 class="mb-3">Detalhes da Ficha Clínica</h4>
                    {% include 'ficha_medica_snippet.html' %}
                </div>

                <div class="tab-pane fade" id="acompanhamentoExames" role="tabpanel" aria-labelledby="exames-tab">
                    <h4 class="mb-3">Histórico e Agendamentos</h4>
                    {% include 'acompanhamento_snippet.html' %}
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawRegistros = '{{ registros_glicemia | tojson | safe }}';
        if (rawRegistros) {
            const registros = JSON.parse(rawRegistros);

            if (registros && registros.length > 0) {
                const labels = registros.map(r => {
                    // Formatação de data/hora
                    const date = new Date(r.data_hora);
                    return `${date.getDate()}/${date.getMonth() + 1} ${date.getHours()}:${date.getMinutes()}`;
                });

                const glicemiaData = registros.map(r => r.valor_glicemia);
                const carbosData = registros.map(r => r.total_carbs || 0); // Assumindo 'carbos' no seu registro
                const kcalData = registros.map(r => r.total_calorias || 0); // Assumindo 'kcal' no seu registro

                // Função de renderização do gráfico
                function renderChart(ctxId, label, data, color) {
                    const ctx = document.getElementById(ctxId)?.getContext('2d');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: label,
                                    data: data,
                                    borderColor: color,
                                    backgroundColor: color.replace(')', ', 0.2)').replace('rgb', 'rgba'),
                                    borderWidth: 2,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: { title: { display: true, text: 'Data e Hora' } },
                                    y: {
                                        title: { display: true, text: label.split(' ')[0] },
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }

                // Renderiza todos os gráficos
                renderChart('glicemiaChart', 'Nível de Glicemia (mg/dL)', glicemiaData, 'rgb(40, 167, 69)'); // Verde
                renderChart('carbosChart', 'Carboidratos (g)', carbosData, 'rgb(255, 193, 7)'); // Amarelo
                renderChart('kcalChart', 'Calorias (Kcal)', kcalData, 'rgb(220, 53, 69)'); // Vermelho/Cores
            }
        }
    });
    const verFichaButton = document.querySelector('a[href="#fichaMedicaTab"][data-bs-toggle="tab"]');

    if (verFichaButton) {
        verFichaButton.addEventListener('click', function (e) {
            e.preventDefault(); // Impede o comportamento padrão do link

            // 1. Encontra o botão real da aba Ficha Médica no topo
            const fichaTabButton = document.getElementById('ficha-tab');

            if (fichaTabButton) {
                // 2. Cria uma nova instância de Tab do Bootstrap
                const fichaTab = new bootstrap.Tab(fichaTabButton);

                // 3. Mostra a aba (troca o conteúdo)
                fichaTab.show();
            }
        });
    }

</script>
{% endblock %}