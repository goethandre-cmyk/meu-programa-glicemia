{% extends "base.html" %}

{% block titulo %}Perfil de {{ paciente.username }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-user-circle me-2"></i>Perfil de {{ paciente.username | capitalize }}</h1>
        <a href="{{ url_for('dashboard_medico') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados Pessoais</h5>
                </div>
                <div class="card-body">
                    <p><strong>Nome de Usuário:</strong> {{ paciente.username }}</p>
                    <p><strong>Email:</strong> {{ paciente.email or 'N/A' }}</p>
                    <p><strong>Telefone:</strong> {{ paciente.telefone or 'N/A' }}</p>
                    <p><strong>Último Acesso:</strong> {{ paciente.ultimo_acesso.strftime('%d/%m/%Y %H:%M') if paciente.ultimo_acesso else 'N/A' }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Histórico de Glicemia (Últimas 20 Leituras)</h5>
                </div>
                <div class="card-body">
                    {% if registros_glicemia %}
                    <canvas id="glicemiaChart"></canvas>
                    {% else %}
                    <p class="text-muted text-center">Nenhum registro de glicemia encontrado.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Agendamentos Futuros</h5>
        </div>
        <div class="card-body">
            {% if agendamentos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Data e Hora</th>
                            <th>Médico</th>
                            <th>Status</th>
                            <th>Observações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agendamento in agendamentos %}
                        <tr>
                            <td>{{ agendamento.data_hora.strftime('%d/%m/%Y às %H:%M') }}</td>
                            <td>{{ agendamento.medico_username }}</td>
                            <td>
                                <span class="badge bg-{{ get_status_class(agendamento.status) }}">{{ agendamento.status | capitalize }}</span>
                            </td>
                            <td>{{ agendamento.observacoes or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">Nenhum agendamento futuro encontrado.</p>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registros = JSON.parse('{{ registros_glicemia | tojson }}');
        
        if (registros && registros.length > 0) {
            const labels = registros.map(r => {
                const date = new Date(r.data_hora);
                return `${date.getDate()}/${date.getMonth() + 1} ${date.getHours()}:${date.getMinutes()}`;
            });
            const data = registros.map(r => r.valor);

            const ctx = document.getElementById('glicemiaChart').getContext('2d');
            const glicemiaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nível de Glicemia (mg/dL)',
                        data: data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data e Hora'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Glicemia (mg/dL)'
                            },
                            suggestedMin: 50,
                            suggestedMax: 250
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}