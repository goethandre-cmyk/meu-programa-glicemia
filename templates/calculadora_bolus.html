{% extends 'base.html' %}

{% block title %}Calculadora de Bolus{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card p-4 shadow-lg border-0">
                <h1 class="mb-4 text-primary">
                    <i class="fas fa-calculator me-2"></i>Calculadora de Bolus
                </h1>
                <p class="text-muted"><i class="fas fa-info-circle me-1"></i>Preencha os campos abaixo para calcular sua
                    dose de insulina.</p>

                {# Bloco de Mensagens Flash #}
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <form action="{{ url_for('calculadora_bolus') }}" method="post">

                    {# 1. Glicemia Atual (AGORA COM PRÉ-PREENCHIMENTO) #}
                    <label for="glicemia_atual" class="form-label">Glicemia no Momento (mg/dL)</label>
                    <div class="mb-3 input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-tint text-danger"></i></span>
                        <input type="number" step="1" class="form-control form-control-lg" id="glicemia_atual"
                            name="glicemia_atual" placeholder="Glicemia no Momento (mg/dL)"
                            value="{{ resultado.glicemia_atual if resultado else ultima_glicemia }}" required>
                    </div>

                    {# 2. Carboidratos da Refeição #}
                    <label for="carbos" class="form-label">Carboidratos da Refeição (g)</label>
                    <div class="mb-4 input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-bread-slice text-success"></i></span>
                        <input type="number" step="0.1" class="form-control form-control-lg" id="carbos" name="carbos"
                            placeholder="Carboidratos da Refeição (g)"
                            value="{{ resultado.carbos if resultado else '' }}" required>
                    </div>

                    {# Botão de Cálculo #}
                    <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                        <i class="fas fa-magic me-2"></i>Calcular Bolus Inteligente
                    </button>
                </form>

                {# Bloco de Resultado #}
                {% if resultado %}
                <div class="alert alert-info mt-4 p-4 border-info">
                    <h4 class="alert-heading text-info"><i class="fas fa-check-circle me-2"></i>Resultado do Cálculo:
                    </h4>
                    <hr>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <i class="fas fa-tint me-1 text-danger"></i> Glicemia: <strong>{{ resultado.glicemia_atual
                                }}
                                mg/dL</strong>
                        </div>
                        <div class="col-6 mb-2">
                            <i class="fas fa-bread-slice me-1 text-success"></i> Carboidratos: <strong>{{
                                resultado.carbos }} g</strong>
                        </div>
                    </div>
                    <hr>

                    <p class="mb-2">
                        <strong><i class="fas fa-utensils me-1"></i> Bolus Alimentar:</strong> <span
                            class="badge bg-success fs-6">{{ resultado.bolus_refeicao }} UI</span>
                        <br><small>(Baseado na Razão I:C de 1:{{ resultado.ric_usado|round(1) }})</small>
                    </p>
                    <p class="mb-2">
                        <strong><i class="fas fa-crosshairs me-1"></i> Bolus de Correção:</strong> <span
                            class="badge bg-danger fs-6">{{ resultado.bolus_correcao }} UI</span>
                        <br><small>(Para chegar à Meta de {{ parametros.glicemia_alvo|round(0) }} mg/dL)</small>
                    </p>
                    <p class="mb-2">
                        <strong><i class="fas fa-clock me-1"></i> Insulina Ativa (IA):</strong> <span
                            class="badge bg-warning text-dark fs-6">-{{ resultado.insulina_ativa }} UI</span>
                        <br><small>(Insulina remanescente de doses anteriores)</small>
                    </p>

                    <h3 class="mt-3 text-primary border-top pt-3">
                        <strong><i class="fas fa-vials me-1"></i> Bolus Total Sugerido:</strong> <span
                            class="badge bg-primary fs-3">{{ resultado.bolus_total }} UI</span>
                    </h3>

                    <hr class="mt-3">
                    <p class="mb-0 small text-dark">
                        <i class="fas fa-exclamation-triangle me-1"></i> **Atenção:** Este cálculo é uma sugestão.
                        **Confirme sempre a dose** com seu profissional de saúde.
                    </p>
                </div>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Painel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}